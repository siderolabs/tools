name: protobuf
dependencies:
  - stage: base
  - stage: patch
steps:
  - sources:
      - url: https://github.com/protocolbuffers/protobuf/releases/download/v3.15.3/protobuf-cpp-3.15.3.tar.gz
        destination: protobuf-cpp.tar.gz
        sha256: 984a65bcc3522b40b7aa493e392dc7ff710c2e4254fdd3ca0594a16f32391199
        sha512: 09d6442b4c20a108cee8d305f815bf809b68f1dd4149cc6a9e17477c3e80747f8672038184b2ca5fc3994a94f32f5d2162335893bcd90ca241b8e330ec1ce6b3
    prepare:
      - |
        tar -xzf protobuf-cpp.tar.gz --strip-components=1

        ./configure \
        --prefix="${TOOLCHAIN}" \
        --disable-shared

        patch -p0 < /pkg/patches/musl-fix.patch
    build:
      - |
        make -j $(nproc)
    install:
      - |
        make DESTDIR=/rootfs install
finalize:
  - from: /rootfs
    to: /
