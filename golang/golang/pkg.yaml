name: golang
dependencies:
- image: docker.io/autonomy/toolchain:d1f6110
- stage: golang-bootstrap
- stage: make
steps:
- sources:
  - url: https://dl.google.com/go/go1.13.1.src.tar.gz
    destination: go.src.tar.gz
    sha256: 81f154e69544b9fa92b1475ff5f11e64270260d46e7e36c34aafc8bc96209358
    sha512: 696fc735271bd76ae59c5015c8efa52121243257f4ffcc1460fd79cf9a5e167db0b30d04137ec71a8789742673c2288bd62d55b546c2d2b2a05e8b3669af8616

  env:
      GOROOT_BOOTSTRAP: "{{ .TOOLCHAIN }}/go_bootstrap"
      GOROOT_FINAL: "{{ .TOOLCHAIN }}/go"
      CGO_ENABLED: "0"

  prepare:
  - tar -xzf go.src.tar.gz --strip-components=1

  build:
  - cd src && sh make.bash
  install:
  - rm -rf pkg/obj
  - rm -rf pkg/bootstrap
  - rm -f pkg/tool/*/api
  - |
    find src \( -type f -a -name "*_test.go" \) \
    -exec rm -rf \{\} \+
  - |
    find src \( -type d -a -name "testdata" \) \
    -exec rm -rf \{\} \+
  - |
    find src -type f -a \( -name "*.bash" -o -name "*.rc" -o -name "*.bat" \) \
    -exec rm -rf \{\} \+

  - mkdir -p "/rootfs${GOROOT_FINAL}"
  - mv * "/rootfs${GOROOT_FINAL}"
finalize:
- from: /rootfs
  to: /
