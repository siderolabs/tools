name: perl
dependencies:
  - stage: base
steps:
  - sources:
      - url: https://www.cpan.org/src/5.0/perl-5.34.0.tar.xz
        destination: perl.tar.xz
        sha256: 82c2e5e5c71b0e10487a80d79140469ab1f8056349ca8545140a224dbbed7ded
        sha512: 691b4b31eacec357191fba777612b4e3eae59e946a22998a50766697c0d61db1d42a9b3bc1e41abf0d1ca1893e4a7c06d7bf3290480cf03d7f79befd7a8a3267
      - url: https://github.com/arsv/perl-cross/releases/download/1.3.6/perl-cross-1.3.6.tar.gz
        destination: perl-cross.tar.gz
        sha256: 4010f41870d64e3957b4b8ce70ebba10a7c4a3e86c5551acb4099c3fcbb37ce5
        sha512: d394fbd75d890442aa599eae8893a26540c8b7af966583ad1c3213c3fe0e074415cfed8814de8f397830833fd78267bdc55adc5267168198f269634c2ef3b982
    prepare:
      - |
        tar -xJf perl.tar.xz --strip-components=1
        tar -xzf perl-cross.tar.gz --strip-components=1

        # This is hardcoded in ./ext/Errno/Errno_pm.PL.
        # Copy it from our toolchain to where it is expected.
        mkdir -p /usr/include
        cp ${TOOLCHAIN}/include/errno.h /usr/include/

        ./configure \
            --prefix=${TOOLCHAIN}
    build:
      - |
        make -j $(nproc)
    install:
      - |
        mkdir -p /rootfs${TOOLCHAIN}/bin
        cp -v perl cpan/podlators/scripts/pod2man /rootfs${TOOLCHAIN}/bin
        mkdir -pv /rootfs${TOOLCHAIN}/lib/perl5/5.34.0
        cp -Rv lib/* /rootfs${TOOLCHAIN}/lib/perl5/5.34.0
finalize:
  - from: /rootfs
    to: /
